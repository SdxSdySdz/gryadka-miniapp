<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–¢–æ–≤–∞—Ä—ã - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</title>
    <link rel="stylesheet" href="../static/css/style.css">
    <link rel="stylesheet" href="../static/css/admin/admin.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="../config.js"></script>
    <style>
        .product-card {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 12px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        .product-card.inactive {
            opacity: 0.6;
        }
        .product-image {
            width: 70px;
            height: 70px;
            min-width: 70px;
            border-radius: 12px;
            object-fit: cover;
            background: var(--background-light);
            flex-shrink: 0;
        }
        .product-info {
            flex: 1;
            min-width: 0;
            overflow: hidden;
        }
        .product-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        .product-price {
            color: var(--primary-green);
            font-weight: bold;
            font-size: 16px;
        }
        .product-meta {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 4px;
        }
        .product-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            margin-top: 4px;
        }
        .badge-hit { background: rgba(255, 193, 7, 0.2); color: #FFA000; }
        .badge-sale { background: rgba(244, 67, 54, 0.2); color: var(--badge-sale); }
        .badge-recommend { background: rgba(76, 175, 80, 0.2); color: var(--primary-green); }
        .product-actions {
            display: flex;
            flex-direction: row;
            gap: 6px;
            flex-shrink: 0;
        }
        .action-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .action-btn svg { width: 16px; height: 16px; }
        .action-btn.edit { background: rgba(76, 175, 80, 0.15); color: var(--primary-green); }
        .action-btn.delete { background: rgba(244, 67, 54, 0.15); color: var(--badge-sale); }
        .add-product-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--primary-green);
            color: white;
            border: none;
            font-size: 28px;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
            cursor: pointer;
            z-index: 100;
        }
        .products-list {
            padding: var(--spacing);
            padding-bottom: 100px;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- –®–∞–ø–∫–∞ -->
        <div class="admin-header mobile-header">
            <button class="back-button" onclick="goBack()">‚Üê</button>
            <div class="header-content">
                <h1 class="admin-title" id="pageTitle">–¢–æ–≤–∞—Ä—ã</h1>
                <p class="admin-subtitle" id="pageSubtitle">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ -->
        <div class="products-list" id="productsList">
            <div class="loading-spinner">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ -->
    <button class="add-product-btn" onclick="openModal()">+</button>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ -->
    <div id="productModal" class="modal">
        <div class="modal-content mobile-modal">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</h2>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body">
                <form id="productForm" class="form-grid">
                    <input type="hidden" id="productId">

                    <div class="form-group">
                        <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                        <input type="text" id="productName" class="form-input" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –Ø–±–ª–æ–∫–∏ –ì–æ–ª–¥–µ–Ω">
                    </div>

                    <div class="form-group">
                        <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea id="productDescription" class="form-textarea" rows="2" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞"></textarea>
                    </div>

                    <div class="form-grid-2">
                        <div class="form-group">
                            <label class="form-label">–¶–µ–Ω–∞ –∑–∞ –∫–≥</label>
                            <input type="number" id="priceKg" class="form-input" step="0.01" min="0" placeholder="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">–¶–µ–Ω–∞ –∑–∞ —à—Ç</label>
                            <input type="number" id="pricePiece" class="form-input" step="0.01" min="0" placeholder="0">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">–ë–µ–π–¥–∂</label>
                        <select id="productBadge" class="form-select">
                            <option value="">–ë–µ–∑ –±–µ–π–¥–∂–∞</option>
                            <option value="hit">üî• –•–∏—Ç</option>
                            <option value="sale">üí∞ –ê–∫—Ü–∏—è</option>
                            <option value="recommend">üëç –°–æ–≤–µ—Ç—É—é</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="productAvailable" checked>
                            <span>–í –Ω–∞–ª–∏—á–∏–∏</span>
                        </label>
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="productActive" checked>
                            <span>–ê–∫—Ç–∏–≤–µ–Ω (–≤–∏–¥–µ–Ω –≤ –º–∞–≥–∞–∑–∏–Ω–µ)</span>
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer mobile-footer">
                <button class="btn btn-secondary btn-half" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-danger btn-half" id="deleteProductBtn" style="display: none;" onclick="deleteCurrentProduct()">–£–¥–∞–ª–∏—Ç—å</button>
                <button class="btn btn-primary btn-half" onclick="saveProduct()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        let tg = null;
        let userId = null;

        try {
            tg = window.Telegram.WebApp;
            tg.expand();
            tg.ready();
            userId = tg.initDataUnsafe?.user?.id;
        } catch(e) {
            console.warn('Telegram init error:', e);
        }

        const API_BASE_URL = window.CONFIG ? window.CONFIG.API_BASE_URL : window.location.origin;

        // –ü–æ–ª—É—á–∞–µ–º category_id –∏–∑ URL
        const urlParams = new URLSearchParams(window.location.search);
        const categoryId = urlParams.get('category_id');

        let category = null;
        let products = [];
        let editingProductId = null;

        function goBack() {
            window.location.href = './categories.html';
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        async function loadData() {
            if (!categoryId) {
                document.getElementById('pageTitle').textContent = '–û—à–∏–±–∫–∞';
                document.getElementById('pageSubtitle').textContent = '–ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –≤—ã–±—Ä–∞–Ω–∞';
                document.getElementById('productsList').innerHTML = `
                    <div class="empty-state-admin">
                        <div class="empty-state-admin-text">–í–µ—Ä–Ω–∏—Ç–µ—Å—å –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</div>
                        <button class="btn btn-primary" onclick="goBack()">–ö –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</button>
                    </div>
                `;
                return;
            }

            try {
                const [catResponse, prodResponse] = await Promise.all([
                    fetch(`${API_BASE_URL}/api/products/categories/${categoryId}`),
                    fetch(`${API_BASE_URL}/api/products/?category_id=${categoryId}&include_inactive=true`)
                ]);

                if (!catResponse.ok) {
                    throw new Error('Category not found');
                }

                category = await catResponse.json();
                products = await prodResponse.json();

                document.getElementById('pageTitle').textContent = `${category.icon || 'üìÅ'} ${category.name}`;
                document.getElementById('pageSubtitle').textContent = `${products.length} —Ç–æ–≤–∞—Ä${products.length === 1 ? '' : products.length < 5 ? '–∞' : '–æ–≤'}`;

                renderProducts();
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('productsList').innerHTML = `
                    <div class="error-message">
                        <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>
                        <button class="btn btn-primary" onclick="loadData()">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
                    </div>
                `;
            }
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
        function renderProducts() {
            const container = document.getElementById('productsList');

            if (products.length === 0) {
                container.innerHTML = `
                    <div class="empty-state-admin">
                        <div class="empty-state-admin-icon">üì¶</div>
                        <div class="empty-state-admin-text">–¢–æ–≤–∞—Ä–æ–≤ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ—Ç</div>
                        <button class="btn btn-primary" onclick="openModal()">–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—ã–π</button>
                    </div>
                `;
                return;
            }

            const badgeNames = { hit: 'üî• –•–∏—Ç', sale: 'üí∞ –ê–∫—Ü–∏—è', recommend: 'üëç –°–æ–≤–µ—Ç—É—é' };

            container.innerHTML = products.map(product => {
                const mainImage = product.images?.find(img => img.is_main) || product.images?.[0];
                const imageUrl = mainImage ? mainImage.image_url : '/static/images/placeholder.jpg';
                const price = product.price_kg || product.price_piece || 0;
                const unit = product.price_kg ? '–∫–≥' : '—à—Ç';

                return `
                <div class="product-card ${product.is_active ? '' : 'inactive'}">
                    <img src="${imageUrl}" alt="${product.name}" class="product-image" onerror="this.src='/static/images/placeholder.jpg'">
                    <div class="product-info">
                        <div class="product-name">${product.name}</div>
                        <div class="product-price">${price.toFixed(0)} ‚ÇΩ / ${unit}</div>
                        <div class="product-meta">
                            ${product.is_available ? '‚úÖ –í –Ω–∞–ª–∏—á–∏–∏' : '‚ùå –ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏'}
                            ${product.is_active ? '' : ' ¬∑ ‚è∏Ô∏è –°–∫—Ä—ã—Ç'}
                        </div>
                        ${product.badge ? `<span class="product-badge badge-${product.badge}">${badgeNames[product.badge] || product.badge}</span>` : ''}
                    </div>
                    <div class="product-actions">
                        <button class="action-btn edit" onclick="editProduct(${product.id})">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                        </button>
                        <button class="action-btn delete" onclick="deleteProduct(${product.id}, '${product.name.replace(/'/g, "\\'")}')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `}).join('');
        }

        // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        function openModal() {
            document.getElementById('productModal').classList.add('active');
            editingProductId = null;
            document.getElementById('modalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä';
            document.getElementById('productForm').reset();
            document.getElementById('productAvailable').checked = true;
            document.getElementById('productActive').checked = true;
            document.getElementById('deleteProductBtn').style.display = 'none';
        }

        // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        function closeModal() {
            document.getElementById('productModal').classList.remove('active');
            editingProductId = null;
        }

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä
        function editProduct(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;

            editingProductId = id;
            document.getElementById('modalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä';
            document.getElementById('productId').value = id;
            document.getElementById('productName').value = product.name;
            document.getElementById('productDescription').value = product.description || '';
            document.getElementById('priceKg').value = product.price_kg || '';
            document.getElementById('pricePiece').value = product.price_piece || '';
            document.getElementById('productBadge').value = product.badge || '';
            document.getElementById('productAvailable').checked = product.is_available;
            document.getElementById('productActive').checked = product.is_active;
            document.getElementById('deleteProductBtn').style.display = 'block';

            document.getElementById('productModal').classList.add('active');
        }

        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–≤–∞—Ä
        async function saveProduct() {
            const name = document.getElementById('productName').value.trim();
            if (!name) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞');
                return;
            }

            const data = {
                category_id: parseInt(categoryId),
                name: name,
                description: document.getElementById('productDescription').value.trim() || null,
                price_kg: parseFloat(document.getElementById('priceKg').value) || null,
                price_piece: parseFloat(document.getElementById('pricePiece').value) || null,
                badge: document.getElementById('productBadge').value || null,
                is_available: document.getElementById('productAvailable').checked,
                is_active: document.getElementById('productActive').checked,
                default_unit: document.getElementById('priceKg').value ? 'kg' : 'piece'
            };

            try {
                let response;
                if (editingProductId) {
                    response = await fetch(`${API_BASE_URL}/api/admin/products/${editingProductId}?telegram_id=${userId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                } else {
                    response = await fetch(`${API_BASE_URL}/api/admin/products?telegram_id=${userId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }

                if (response.ok) {
                    alert(editingProductId ? '–¢–æ–≤–∞—Ä –æ–±–Ω–æ–≤–ª—ë–Ω' : '–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω');
                    closeModal();
                    loadData();
                } else {
                    const error = await response.json();
                    alert(error.detail || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                }
            } catch (error) {
                console.error('Error saving product:', error);
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
            }
        }

        // –£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä
        async function deleteProduct(id, name) {
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä "${name}"?`)) return;

            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/products/${id}?telegram_id=${userId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('–¢–æ–≤–∞—Ä —É–¥–∞–ª—ë–Ω');
                    loadData();
                } else {
                    const error = await response.json();
                    alert(error.detail || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                }
            } catch (error) {
                console.error('Error deleting product:', error);
                alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
            }
        }

        // –£–¥–∞–ª–∏—Ç—å —Ç–µ–∫—É—â–∏–π —Ç–æ–≤–∞—Ä (–∏–∑ –º–æ–¥–∞–ª–∫–∏)
        function deleteCurrentProduct() {
            if (!editingProductId) return;
            const product = products.find(p => p.id === editingProductId);
            closeModal();
            deleteProduct(editingProductId, product?.name || '');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        loadData();
    </script>
</body>
</html>
