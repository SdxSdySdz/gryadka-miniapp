<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</title>
    <link rel="stylesheet" href="../static/css/style.css">
    <link rel="stylesheet" href="../static/css/admin/admin.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="../config.js"></script>
    <style>
        .category-card {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .category-card:active {
            transform: scale(0.98);
        }
        .category-products-count {
            background: var(--primary-green);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .add-category-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--primary-green);
            color: white;
            border: none;
            font-size: 28px;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
            cursor: pointer;
            z-index: 100;
        }
        .category-edit-btn {
            background: rgba(76, 175, 80, 0.15);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .category-edit-btn svg {
            width: 18px;
            height: 18px;
            color: var(--primary-green);
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- –®–∞–ø–∫–∞ -->
        <div class="admin-header mobile-header">
            <button class="back-button" onclick="window.location.href='./index.html'">‚Üê</button>
            <div class="header-content">
                <h1 class="admin-title">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h1>
                <p class="admin-subtitle">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ç–æ–≤–∞—Ä–æ–≤</p>
            </div>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π -->
        <div class="categories-list" id="categoriesList">
            <div class="loading-spinner">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
    <button class="add-category-btn" onclick="openModal('categoryModal')">+</button>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
    <div id="categoryModal" class="modal">
        <div class="modal-content mobile-modal">
            <div class="modal-header">
                <h2 class="modal-title" id="categoryModalTitle">–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</h2>
                <button class="modal-close" onclick="closeModal('categoryModal')">√ó</button>
            </div>
            <div class="modal-body">
                <form id="categoryForm" class="form-grid">
                    <input type="hidden" name="category_id" id="categoryId">

                    <div class="form-group">
                        <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
                        <input type="text" name="name" id="categoryName" class="form-input" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –§—Ä—É–∫—Ç—ã">
                    </div>

                    <div class="form-group">
                        <label class="form-label">–ò–∫–æ–Ω–∫–∞ (emoji)</label>
                        <input type="text" name="icon" id="categoryIcon" class="form-input" placeholder="üçé">
                        <div class="emoji-picker">
                            <button type="button" class="emoji-btn" onclick="setEmoji('üçé')">üçé</button>
                            <button type="button" class="emoji-btn" onclick="setEmoji('üçä')">üçä</button>
                            <button type="button" class="emoji-btn" onclick="setEmoji('üçã')">üçã</button>
                            <button type="button" class="emoji-btn" onclick="setEmoji('üçá')">üçá</button>
                            <button type="button" class="emoji-btn" onclick="setEmoji('üçì')">üçì</button>
                            <button type="button" class="emoji-btn" onclick="setEmoji('ü•ï')">ü•ï</button>
                            <button type="button" class="emoji-btn" onclick="setEmoji('ü•¨')">ü•¨</button>
                            <button type="button" class="emoji-btn" onclick="setEmoji('üçÖ')">üçÖ</button>
                            <button type="button" class="emoji-btn" onclick="setEmoji('ü•í')">ü•í</button>
                            <button type="button" class="emoji-btn" onclick="setEmoji('üåΩ')">üåΩ</button>
                            <button type="button" class="emoji-btn" onclick="setEmoji('ü•î')">ü•î</button>
                            <button type="button" class="emoji-btn" onclick="setEmoji('üßÖ')">üßÖ</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">–ü–æ—Ä—è–¥–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏</label>
                        <input type="number" name="sort_order" id="categorySortOrder" class="form-input" value="0" min="0">
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="is_active" id="categoryIsActive" checked>
                            <span>–ê–∫—Ç–∏–≤–Ω–∞ (–æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ –º–∞–≥–∞–∑–∏–Ω–µ)</span>
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer mobile-footer">
                <button class="btn btn-secondary btn-half" onclick="closeModal('categoryModal')">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-danger btn-half" id="deleteCategoryBtn" style="display: none;" onclick="deleteCurrentCategory()">–£–¥–∞–ª–∏—Ç—å</button>
                <button class="btn btn-primary btn-half" onclick="saveCategory()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        let tg = null;
        let userId = null;

        try {
            tg = window.Telegram.WebApp;
            tg.expand();
            tg.ready();
            userId = tg.initDataUnsafe?.user?.id;
        } catch(e) {
            console.warn('Telegram init error:', e);
        }

        const API_BASE_URL = window.CONFIG ? window.CONFIG.API_BASE_URL : window.location.origin;

        let categories = [];
        let products = [];
        let editingCategoryId = null;

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        async function loadData() {
            try {
                const [catResponse, prodResponse] = await Promise.all([
                    fetch(`${API_BASE_URL}/api/products/categories?include_inactive=true`),
                    fetch(`${API_BASE_URL}/api/products/?include_inactive=true`)
                ]);

                categories = await catResponse.json();
                products = await prodResponse.json();

                renderCategories();
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('categoriesList').innerHTML = `
                    <div class="error-message">
                        <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>
                        <button class="btn btn-primary" onclick="loadData()">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
                    </div>
                `;
            }
        }

        // –ü–æ–¥—Å—á—ë—Ç —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        function getProductsCount(categoryId) {
            return products.filter(p => p.category_id === categoryId).length;
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        function renderCategories() {
            const container = document.getElementById('categoriesList');

            if (categories.length === 0) {
                container.innerHTML = `
                    <div class="empty-state-admin">
                        <div class="empty-state-admin-icon">üìÅ</div>
                        <div class="empty-state-admin-text">–ö–∞—Ç–µ–≥–æ—Ä–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</div>
                        <button class="btn btn-primary" onclick="openModal('categoryModal')">–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—É—é</button>
                    </div>
                `;
                return;
            }

            container.innerHTML = categories.map(cat => {
                const count = getProductsCount(cat.id);
                return `
                <div class="category-card ${cat.is_active ? '' : 'inactive'}" onclick="openCategory(${cat.id})">
                    <div class="category-info">
                        <div class="category-icon">${cat.icon || 'üìÅ'}</div>
                        <div class="category-details">
                            <div class="category-name">${cat.name}</div>
                            <div class="category-meta">
                                ${cat.is_active ? '‚úÖ –ê–∫—Ç–∏–≤–Ω–∞' : '‚è∏Ô∏è –°–∫—Ä—ã—Ç–∞'}
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span class="category-products-count">${count} —Ç–æ–≤–∞—Ä${count === 1 ? '' : count < 5 ? '–∞' : '–æ–≤'}</span>
                        <button class="category-edit-btn" onclick="event.stopPropagation(); editCategory(${cat.id})">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `}).join('');
        }

        // –û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é (–ø–µ—Ä–µ–π—Ç–∏ –∫ —Ç–æ–≤–∞—Ä–∞–º)
        function openCategory(categoryId) {
            window.location.href = `./products.html?category_id=${categoryId}`;
        }

        // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
            editingCategoryId = null;
            document.getElementById('categoryModalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é';
            document.getElementById('categoryForm').reset();
            document.getElementById('categoryIsActive').checked = true;
            document.getElementById('deleteCategoryBtn').style.display = 'none';
        }

        // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            editingCategoryId = null;
        }

        // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å emoji
        function setEmoji(emoji) {
            document.getElementById('categoryIcon').value = emoji;
        }

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é
        function editCategory(id) {
            const category = categories.find(c => c.id === id);
            if (!category) return;

            editingCategoryId = id;
            document.getElementById('categoryModalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é';
            document.getElementById('categoryId').value = id;
            document.getElementById('categoryName').value = category.name;
            document.getElementById('categoryIcon').value = category.icon || '';
            document.getElementById('categorySortOrder').value = category.sort_order || 0;
            document.getElementById('categoryIsActive').checked = category.is_active;
            document.getElementById('deleteCategoryBtn').style.display = 'block';

            document.getElementById('categoryModal').classList.add('active');
        }

        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é
        async function saveCategory() {
            const name = document.getElementById('categoryName').value.trim();
            const icon = document.getElementById('categoryIcon').value.trim();
            const sortOrder = parseInt(document.getElementById('categorySortOrder').value) || 0;
            const isActive = document.getElementById('categoryIsActive').checked;

            if (!name) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏');
                return;
            }

            const data = {
                name: name,
                icon: icon || null,
                sort_order: sortOrder,
                is_active: isActive
            };

            try {
                let response;
                if (editingCategoryId) {
                    response = await fetch(`${API_BASE_URL}/api/admin/categories/${editingCategoryId}?telegram_id=${userId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                } else {
                    response = await fetch(`${API_BASE_URL}/api/admin/categories?telegram_id=${userId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }

                if (response.ok) {
                    alert(editingCategoryId ? '–ö–∞—Ç–µ–≥–æ—Ä–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞' : '–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Å–æ–∑–¥–∞–Ω–∞');
                    closeModal('categoryModal');
                    loadData();
                } else {
                    const error = await response.json();
                    alert(error.detail || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                }
            } catch (error) {
                console.error('Error saving category:', error);
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
            }
        }

        // –£–¥–∞–ª–∏—Ç—å —Ç–µ–∫—É—â—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
        async function deleteCurrentCategory() {
            if (!editingCategoryId) return;

            const category = categories.find(c => c.id === editingCategoryId);
            const count = getProductsCount(editingCategoryId);

            if (count > 0) {
                alert(`–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Å —Ç–æ–≤–∞—Ä–∞–º–∏ (${count} —à—Ç). –°–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç–µ —Ç–æ–≤–∞—Ä—ã.`);
                return;
            }

            if (!confirm(`–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é "${category?.name}"?`)) return;

            try {
                const response = await fetch(`${API_BASE_URL}/api/admin/categories/${editingCategoryId}?telegram_id=${userId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('–ö–∞—Ç–µ–≥–æ—Ä–∏—è —É–¥–∞–ª–µ–Ω–∞');
                    closeModal('categoryModal');
                    loadData();
                } else {
                    const error = await response.json();
                    alert(error.detail || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                }
            } catch (error) {
                console.error('Error deleting category:', error);
                alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        loadData();
    </script>
</body>
</html>
